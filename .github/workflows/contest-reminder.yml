name: Contest Reminders to Discord

on:
  schedule:
    - cron: "*/5 * * * *" # every 5 minutes
  workflow_dispatch:

jobs:
  remind:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install jq -y

      # Restore cached posted.json if exists
      - name: Restore posted.json cache
        uses: actions/cache@v3
        with:
          path: posted.json
          key: posted-json-cache

      # Ensure posted.json exists
      - name: Ensure posted.json exists
        run: |
          if [ ! -f posted.json ]; then
            echo "[]" > posted.json
          fi

      - name: Fetch contests and merge into one array
        run: |
          > temp.json
          for platform in atcoder codechef codeforces hackerearth hackerrank leetcode toph; do
            echo "Fetching $platform..."
            curl -s "https://contest-hive.vercel.app/api/$platform" | jq '.data[]?' >> temp.json
          done
          jq -s '[.[][]? | select(.startTime?)]' temp.json > new.json
          rm temp.json

      - name: Filter upcoming contests (next 10 minutes)
        run: |
          now=$(date -u +%s)
          window=$((10 * 60)) # 10 minutes before start
          jq --argjson now "$now" --argjson window "$window" '[ .[]? | select((.startTime | fromdateiso8601) - $now < $window and (.startTime | fromdateiso8601) - $now > 0) ]' new.json > upcoming.json

      - name: Send new contests to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          posted_urls=$(jq -r '.[].url?' posted.json)
          upcoming=$(jq -c '.[]?' upcoming.json)

          for contest in $upcoming; do
            url=$(echo "$contest" | jq -r '.url')
            if ! echo "$posted_urls" | grep -q "$url"; then
              title=$(echo "$contest" | jq -r '.title')
              platform=$(echo "$contest" | jq -r '.platform')
              start=$(echo "$contest" | jq -r '.startTime')

              message="â° **Upcoming $platform Contest!**\n**$title**\nðŸ•’ Starts: $start\nðŸ”— $url"

              echo "Posting $title..."
              curl -H "Content-Type: application/json" \
                   -X POST \
                   -d "{\"content\": \"$message\"}" \
                   "$DISCORD_WEBHOOK"

              # Append to posted.json
              jq --arg url "$url" '. + [{"url": $url}]' posted.json > tmp.json && mv tmp.json posted.json
            fi
          done

      # Save posted.json to cache for next run
      - name: Save posted.json cache
        uses: actions/cache@v3
        with:
          path: posted.json
          key: posted-json-cache
